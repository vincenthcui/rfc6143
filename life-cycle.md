# 生命周期

RFB 协议分为握手和交换两个阶段，握手阶段包含协议版本握手和安全握手；交换分为初始化和帧交换。

- 协议版本握手
- 安全握手
- 帧交换

> TODO: 插图

## 协议版本握手

在协议版本握手阶段，服务端和客户端交换支持的协议版本，选定共同支持的最新版本号。

3.3、3.7和3.8 是公开支持的三个版本，如果服务端/客户端或发送了其他版本号，应将其视为 3.3 版本的变种，即不兼容 3.7/3.8 版本的握手协议。

### 不兼容协议

如果客户端和服务端无法就协议版本达成一致，例如，客户端选择的旧协议版本服务端不提供兼容，服务端会在发送空的安全握手协议和退出说明后，主动断开连接。

## 安全握手

选定协议版本后，服务端和客户端继续交换所支持的认证方式。标准提供 None 和 VNC Auth 两种认证方式，如果客户端和服务端支持拓展加密协议，允许在交换安全协议后，继续交互数据包，完成认证过程。

- None: 不需要认证
- VNC Auth: VNC 鉴权

### VNC Auth

VNC Auth 是规范提供的加密方式。服务端首先向客户端发送长度为 16 字节的随机数据包，由客户端使用密钥加密后提交给服务器验证。

VNC Auth 使用零知识证明，保证密钥不会经由网络传输，防止可能存在的链路监听。