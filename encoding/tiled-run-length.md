# 卷积游程编码 TRLE

TRLE（Tiled Run-Length Encoding），使用卷积技术、调色板技术以及游程编码，对传输的桌面图像进行压缩。

在卷积技术（Tiled）中，矩形被分为 N 个 16x16 的小矩形（叫做”瓦片“），瓦片按从左到右，从上到下的顺序排列成一位数组。如果矩形的尺寸不是 16 的整数倍，最后一列瓦片的宽度应为实际宽度（小于16），最后一排瓦片的高度应为实际高度（小于16）。

TRLE 中使用新的类型 CPIXEL （compressed pixel）表达像素点，兼容已约定的 PIXEL_FORMAT。在 CPIXEL 中，true-color-flag 是非零值，bits-per-pixel 是 32，depth 是 24，或更少（信息压缩比更高）。组成红黄蓝的色彩只使用最低三位或最高三位有效字节。

## 子编码

每个瓦片（Tile）使用一个字节表示子编码类型。子编码类型的最高比特表示 Tile 是否使用游程编码。低 7-bit 指示调色板的大小。0 代表不使用调色板，1 代表只有一种颜色，2-127 代表调色板的大小。127/129 是两个特殊值，表示跟上一个 Tile 共享调色板。

```
+---------------+--------------+------------------+
| No. of bits   | Type [Value] | Description      |
+------------------------------+------------------+
| 1             | bit          | run-length-flag  |
| 2-8           | bit          | palette-length   |
+------------------------------+------------------+
```

> TODO: 如何确定最后一行/最后一列的长度？

### B 0000 0000

Raw 格式，不使用游程编码，不使用调色板。原始像素信息跟在 sub-encoding 后面。

```
+-----------------------------+--------------+-------------+
| No. of bytes                | Type [Value] | Description |
+-----------------------------+--------------+-------------+
| width*height*BytesPerCPixel | CPIXEL array | pixels      |
+-----------------------------+--------------+-------------+
```

### B 0000 0001

不使用游程编码，单色。原始像素信息只传递颜色值。

```
+----------------+--------------+-------------+
| No. of bytes   | Type [Value] | Description |
+----------------+--------------+-------------+
| bytesPerCPixel | CPIXEL       | pixelValue  |
+----------------+--------------+-------------+
```

### [B 0000 0002, B 0001 0000]

压缩调色板类型。调色板色值紧跟 sub-encoding 提供，数量在数值上等于 `sub-encoding`。
每个像素使用的 bit 数由调色板大小确定。
代表像素的比特被打包进字节存储（为了进一步压缩体积），最高有效位代表最做的像素。
如果 Tile 的数量不是 2/4/8 的倍数，需要添加填充位，对齐到字节。

|调色板大小|像素比特数|打包后字节数|
|:---:|:---:|---|
|=2|1|m = (width+7) // 8 *height|
|<=4|2|m = (width+3) // 4 * height|
|<=16|4|m = (width+1) // 2 * height|

```
+----------------------------+--------------+--------------+
| No. of bytes               | Type [Value] | Description  |
+----------------------------+--------------+--------------+
| paletteSize*bytesPerCPixel | CPIXEL array | palette      |
| m                          | U8 array     | packedPixels |
+----------------------------+--------------+--------------+
```

### [B 0001 0001, B 0111 1110]

保留，色彩数量太多，压缩调色板的信息率远低于使用调色板的 RLE

### B 0111 1111

复用前一个 Tile 的调色板

### B 1000 0000

RLE 格式，使用游程编码。游程在一维化后，允许跨行计算。
长度由一个或多个字节表示，到第一个不是 255（0xFF）停止。

```
+-------------------------+--------------+-----------------------+
| No. of bytes            | Type [Value] | Description           |
+-------------------------+--------------+-----------------------+
| bytesPerCPixel          | CPIXEL       | pixelValue            |
| div(runLength - 1, 255) | U8 array     | 255                   |
| 1                       | U8           | (runLength-1) mod 255 |
+-------------------------+--------------+-----------------------+
```

例如：

|游程长度|字节表示|
|:---:|:---:|
|1|0x00|
|255|0xFE|
|256| 0xFF00|
|257|0xFF01|
|510|0xFFFE|
|511|0xFFFF00|